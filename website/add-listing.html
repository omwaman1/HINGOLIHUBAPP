<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Listing - Hingoli Hub‚Ñ¢</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">

    <style>
        .add-listing-page {
            padding-top: 80px;
            min-height: 100vh;
            background: var(--gray-50);
        }

        .form-container {
            max-width: 700px;
            margin: 0 auto;
            padding: var(--space-4);
        }

        .page-header {
            margin-bottom: var(--space-6);
        }

        .page-header h1 {
            font-size: var(--font-size-2xl);
            font-weight: 700;
        }

        .form-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
        }

        .form-section {
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-6);
            border-bottom: 1px solid var(--gray-100);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: var(--font-size-base);
            font-weight: 700;
            margin-bottom: var(--space-4);
            color: var(--gray-800);
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-group label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin-bottom: var(--space-1);
            color: var(--gray-700);
        }

        .form-group label span {
            color: var(--error);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-500);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .type-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }

        .type-option {
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .type-option:hover {
            border-color: var(--primary-300);
        }

        .type-option.selected {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .type-option input {
            display: none;
        }

        .type-icon {
            font-size: 1.5rem;
            margin-bottom: var(--space-2);
        }

        .type-label {
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .image-upload {
            border: 2px dashed var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .image-upload:hover {
            border-color: var(--primary-300);
        }

        .image-upload input {
            display: none;
        }

        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: var(--radius-md);
            margin-top: var(--space-3);
        }

        .conditional-fields {
            display: none;
        }

        .conditional-fields.show {
            display: block;
        }

        .submit-btn {
            width: 100%;
            padding: var(--space-4);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: var(--font-size-base);
            cursor: pointer;
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .type-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <a href="index.html" class="logo">
                <img src="images/logo.jpg" alt="Hingoli Hub"
                    style="width: 32px; height: 32px; border-radius: 8px; object-fit: cover;">
                <span class="logo-text">Hingoli Hub‚Ñ¢</span>
            </a>

            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="listings.html?type=services">Services</a></li>
                <li><a href="listings.html?type=selling">Buy & Sell</a></li>
                <li><a href="listings.html?type=business">Businesses</a></li>
                <li><a href="listings.html?type=jobs">Jobs</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>

            <div id="authNav">
                <a href="login.html" class="btn btn-white">üë§ Login</a>
            </div>
        </nav>
    </header>

    <!-- Add Listing Form -->
    <div class="add-listing-page">
        <div class="form-container">
            <div class="page-header">
                <a href="dashboard.html"
                    style="color: var(--gray-500); text-decoration: none; font-size: var(--font-size-sm);">‚Üê Back to
                    Dashboard</a>
                <h1>‚ûï Add New Listing</h1>
            </div>

            <form class="form-card" id="listingForm" onsubmit="submitListing(event)">
                <!-- Listing Type -->
                <div class="form-section">
                    <h3 class="section-title">What do you want to list?</h3>
                    <div class="type-selector">
                        <label class="type-option" onclick="selectType('services')">
                            <input type="radio" name="listing_type" value="services">
                            <div class="type-icon">üîß</div>
                            <div class="type-label">Service</div>
                        </label>
                        <label class="type-option" onclick="selectType('selling')">
                            <input type="radio" name="listing_type" value="selling">
                            <div class="type-icon">üõí</div>
                            <div class="type-label">Product</div>
                        </label>
                        <label class="type-option" onclick="selectType('business')">
                            <input type="radio" name="listing_type" value="business">
                            <div class="type-icon">üè™</div>
                            <div class="type-label">Business</div>
                        </label>
                        <label class="type-option" onclick="selectType('jobs')">
                            <input type="radio" name="listing_type" value="jobs">
                            <div class="type-icon">üíº</div>
                            <div class="type-label">Job</div>
                        </label>
                    </div>
                </div>

                <!-- Basic Info -->
                <div class="form-section">
                    <h3 class="section-title">Basic Information</h3>

                    <div class="form-group">
                        <label>Title <span>*</span></label>
                        <input type="text" name="title" id="title" placeholder="Enter a descriptive title" required>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" id="description"
                            placeholder="Describe your listing in detail..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Category <span>*</span></label>
                            <select name="category_id" id="categorySelect" required>
                                <option value="">Select category</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Subcategory</label>
                            <select name="subcategory_id" id="subcategorySelect">
                                <option value="">Select subcategory</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Product Fields (for selling type) -->
                <div class="form-section conditional-fields" id="productFields">
                    <h3 class="section-title">Product Details</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Price (‚Çπ) <span>*</span></label>
                            <input type="number" name="price" id="price" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Discounted Price (‚Çπ)</label>
                            <input type="number" name="discounted_price" id="discounted_price" placeholder="Optional">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Condition</label>
                            <select name="condition" id="condition">
                                <option value="new">New</option>
                                <option value="old">Used</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Stock Quantity</label>
                            <input type="number" name="stock_qty" id="stock_qty" value="1" min="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="sell_online" id="sell_online" checked>
                            Available for online purchase
                        </label>
                    </div>
                </div>

                <!-- Location (for non-selling types) -->
                <div class="form-section conditional-fields" id="locationFields">
                    <h3 class="section-title">Location</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>City <span>*</span></label>
                            <input type="text" name="city" id="city" value="Hingoli">
                        </div>
                        <div class="form-group">
                            <label>State</label>
                            <input type="text" name="state" id="state" value="Maharashtra">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Address / Location Details</label>
                        <input type="text" name="location" id="location" placeholder="Shop address or area">
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="form-section">
                    <h3 class="section-title">Image</h3>

                    <label class="image-upload" id="imageUpload">
                        <input type="file" name="main_image" id="mainImage" accept="image/*"
                            onchange="previewImage(this)">
                        <div>
                            <div style="font-size: 2rem; margin-bottom: var(--space-2);">üì∑</div>
                            <p>Click to upload image</p>
                            <p style="font-size: var(--font-size-xs); color: var(--gray-500);">JPG, PNG up to 5MB</p>
                        </div>
                        <img id="imagePreview" class="image-preview" style="display: none;">
                    </label>
                </div>

                <!-- Submit -->
                <button type="submit" class="submit-btn" id="submitBtn">
                    Create Listing
                </button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/components.js"></script>
    <script src="js/app.js"></script>
    <script>
        let selectedType = '';
        let categories = [];

        document.addEventListener('DOMContentLoaded', async () => {
            app.initAuth();

            if (!app.isLoggedIn()) {
                window.location.href = 'login.html?redirect=add-listing.html';
                return;
            }

            await loadCategories();
        });

        async function loadCategories() {
            try {
                const response = await api.getCategories();
                if (response.success) {
                    categories = response.data || [];
                }
            } catch (error) {
                console.error('Failed to load categories');
            }
        }

        function selectType(type) {
            selectedType = type;

            // Update UI
            document.querySelectorAll('.type-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`input[value="${type}"]`).parentElement.classList.add('selected');
            document.querySelector(`input[value="${type}"]`).checked = true;

            // Show/hide conditional fields
            document.getElementById('productFields').classList.toggle('show', type === 'selling');
            document.getElementById('locationFields').classList.toggle('show', type !== 'selling');

            // Update categories dropdown
            updateCategoriesDropdown(type);
        }

        function updateCategoriesDropdown(type) {
            const select = document.getElementById('categorySelect');
            const filteredCategories = categories.filter(c => c.listing_type === type);

            select.innerHTML = '<option value="">Select category</option>' +
                filteredCategories.map(c => `<option value="${c.category_id}">${c.name}</option>`).join('');
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function submitListing(event) {
            event.preventDefault();

            if (!selectedType) {
                alert('Please select a listing type');
                return;
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            const formData = new FormData();
            formData.append('listing_type', selectedType);
            formData.append('title', document.getElementById('title').value.trim());
            formData.append('description', document.getElementById('description').value.trim());
            formData.append('category_id', document.getElementById('categorySelect').value);

            const subcategory = document.getElementById('subcategorySelect').value;
            if (subcategory) formData.append('subcategory_id', subcategory);

            if (selectedType === 'selling') {
                formData.append('price', document.getElementById('price').value || 0);
                formData.append('discounted_price', document.getElementById('discounted_price').value || '');
                formData.append('condition', document.getElementById('condition').value);
                formData.append('stock_qty', document.getElementById('stock_qty').value || 1);
                formData.append('sell_online', document.getElementById('sell_online').checked ? '1' : '0');
            } else {
                formData.append('city', document.getElementById('city').value.trim());
                formData.append('state', document.getElementById('state').value.trim());
                formData.append('location', document.getElementById('location').value.trim());
            }

            const imageFile = document.getElementById('mainImage').files[0];
            if (imageFile) {
                formData.append('main_image', imageFile);
            }

            try {
                const response = await api.createListing(formData);

                if (response.success) {
                    alert('Listing created successfully!');
                    window.location.href = 'dashboard.html';
                } else {
                    alert(response.message || 'Failed to create listing');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }

            btn.disabled = false;
            btn.textContent = 'Create Listing';
        }
    </script>
</body>

</html>